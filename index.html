<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PayEasy - Fast, Secure Payments on Stellar & Midnight</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Use specific compatible versions of React, ReactDOM and React Router -->
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/react-router-dom@5.3.0/umd/react-router-dom.min.js"></script>
  <script src="https://unpkg.com/stellar-sdk/dist/stellar-sdk.js"></script>
  <script src="JS/privacy-score.js"></script>
  <script src="JS/transaction-privacy.js"></script>
  <script src="services/MidnightService.js"></script>
  <script src="services/AuthService.js"></script>
  <script src="services/ExchangeService.js"></script>
  <script src="services/ValidationService.js"></script>
  
  <!-- Fallback PolkadotService definition -->
  <script>
    window.PolkadotService = window.PolkadotService || {
      connected: false,
      accounts: [],
      selectedAccount: null,
      connectWallet: async function() {
        this.connected = true;
        this.accounts = [
          { address: '5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY', meta: { name: 'Alice' } }
        ];
        return { success: true, accounts: this.accounts };
      },
      selectAccount: function(account) {
        this.selectedAccount = account;
        return { success: true };
      },
      checkUSDCBalance: async function() {
        return { success: true, balance: '100.00', hasEnoughFunds: true };
      },
      sendUSDCTransaction: async function() {
        return { 
          success: true, 
          transactionHash: 'dot-tx-' + Math.random().toString(16).substring(2, 10)
        };
      }
    };
    window.Services = window.Services || {};
    window.Services.PolkadotService = window.PolkadotService;
  </script>
  
  <link href="css/output.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    /* Navigation styles */
    .passkey-nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: rgba(30, 64, 175, 0.95);
      color: white;
      padding: 0.5rem 1rem;
      display: flex;
      justify-content: center;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .passkey-nav ul {
      display: flex;
      gap: 1.5rem;
    }
    
    .passkey-nav ul li a {
      color: white;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 0.25rem;
      transition: background-color 0.2s;
      font-weight: 500;
      display: flex;
      align-items: center;
    }
    
    .passkey-nav ul li a:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .passkey-nav ul li a svg {
      margin-right: 0.5rem;
    }
    
    #root {
      padding-top: 3rem;
    }
    
    /* Passkey authentication badge styles */
    .passkey-badge {
      display: inline-flex;
      align-items: center;
      background-color: #EBF5FF;
      color: #1E40AF;
      font-size: 0.75rem;
      font-weight: 500;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      margin-left: 0.5rem;
    }
    
    .passkey-badge svg {
      width: 0.875rem;
      height: 0.875rem;
      margin-right: 0.25rem;
    }
  </style>
  <!-- Add a favicon link -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’¸</text></svg>">
</head>
<body class="bg-gray-100">
  <!-- Passkey Navigation -->
  <nav class="passkey-nav">
    <ul>
      <li>
        <a href="index.html">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
          </svg>
          PayEasy Dashboard
        </a>
      </li>
    </ul>
  </nav>

  <!-- This is the root element where our React component will be rendered -->
  <div id="root"></div>
  
  <!-- Load Polkadot Service just before main app -->
  <script src="services/PolkadotService.js"></script>
  
  <!-- Load cross-chain services -->
  <script src="services/LaunchtubeService.js"></script>
  <script src="services/StellarPaymentContract.js"></script>
  <script src="services/PolkadotPaymentHandler.js"></script>
  <script src="components/PasskeyAuth.js"></script>
  
  <!-- Import our main component -->
  <script type="text/babel" data-presets="react" src="payeasy-visualization-phase2.jsx"></script>
  
  <!-- Initialize the application with React 17 method -->
  <script type="text/babel">
    // Extend AuthService to support passkey authentication
    if (window.AuthService) {
      // Add passkey authentication flag to track when a user logs in with passkey
      window.AuthService.isPasskeyAuthenticated = false;
      
      // Store the original login method
      const originalLogin = window.AuthService.login;
      
      // Override the login method to handle passkey authentication
      window.AuthService.login = function(address, isPasskeyAuth = false) {
        // Set the passkey authentication flag if applicable
        this.isPasskeyAuthenticated = isPasskeyAuth;
        
        // Call the original login method
        return originalLogin.call(this, address);
      }
      
      // Add method to check if user logged in with passkey
      window.AuthService.isLoggedInWithPasskey = function() {
        return this.isPasskeyAuthenticated;
      }
    }
    
    // Add global error handler
    window.addEventListener('error', function(event) {
      console.error('Global error caught:', event.error?.message || event.message);
      
      // For "cannot read property of undefined" errors, check if PolkadotService is available
      if (event.error?.message?.includes('undefined') || event.message?.includes('undefined')) {
        // If service is missing, try to reinitialize it
        if (!window.PolkadotService) {
          // Reinitialize the fallback service
          window.PolkadotService = {
            connected: false,
            accounts: [],
            selectedAccount: null,
            connectWallet: async function() {
              this.connected = true;
              this.accounts = [
                { address: '5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY', meta: { name: 'Alice' } }
              ];
              return { success: true, accounts: this.accounts };
            },
            selectAccount: function(account) {
              this.selectedAccount = account;
              return { success: true };
            },
            checkUSDCBalance: async function() {
              return { success: true, balance: '100.00', hasEnoughFunds: true };
            },
            sendUSDCTransaction: async function() {
              return { 
                success: true, 
                transactionHash: 'dot-tx-' + Math.random().toString(16).substring(2, 10)
              };
            }
          };
        }
      }
    });
    
    // Wait for DOM and all scripts to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      try {
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const address = urlParams.get('address');
        const passkey_auth = urlParams.get('passkey_auth') === 'true';
        
        // If address is present in URL, auto-fill it in login form and auto-submit
        if (address) {
          console.log("Detected login with address:", address, "Passkey auth:", passkey_auth);
          
          // Set up a mutation observer to detect when the form is available
          const observer = new MutationObserver(function(mutations, obs) {
            const loginAddressField = document.getElementById('stellar-address');
            if (loginAddressField) {
              console.log("Found login field, auto-filling with address", address);
              loginAddressField.value = address;
              
              // Find the login button
              const loginForm = loginAddressField.closest('form');
              if (loginForm) {
                console.log("Auto-submitting login form with passkey auth =", passkey_auth);
                
                // Inject custom event handler before clicking
                const loginButton = loginForm.querySelector('button[type="submit"]');
                if (loginButton) {
                  // Create and store the original onclick handler
                  const originalOnClick = loginButton.onclick;
                  
                  // Set a new onclick handler
                  loginButton.onclick = function(event) {
                    event.preventDefault();
                    
                    // Set global flag for passkey authentication
                    if (passkey_auth && window.AuthService) {
                      window.AuthService.isPasskeyAuthenticated = true;
                    }
                    
                    // Call the original handler
                    if (typeof originalOnClick === 'function') {
                      return originalOnClick.call(this, event);
                    }
                    return true;
                  };
                  
                  // Click the button after a short delay
                  setTimeout(() => {
                    loginButton.click();
                  }, 500);
                }
              }
              
              // Disconnect the observer once we've handled the address
              obs.disconnect();
            }
          });
          
          // Start observing the document body for added nodes
          observer.observe(document.body, { childList: true, subtree: true });
        }
        
        // Render the full app directly
        ReactDOM.render(
          <PayEasyPhase2 />,
          document.getElementById('root')
        );
      } catch (err) {
        console.error("Error rendering React app:", err);
        // Display a basic error message on the page
        document.getElementById('root').innerHTML = `
          <div style="padding: 20px; color: red; text-align: center;">
            <h2>Error Loading Application</h2>
            <p>${err.message}</p>
            <button onclick="location.reload()">Reload Page</button>
          </div>
        `;
      }
    });
  </script>
  
  <!-- Load integrated feature scripts that enhance the existing UI -->
  <script src="integrated-passkey-auth.js"></script>
  <script src="integrated-cross-chain.js"></script>
</body>
</html>